#include <assert.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <unistd.h>
#include <time.h>
#include <sys/wait.h>

void afficher(char* crible, int n)
{
    // TODO: afficher les nombres premiers plus petits que n
    printf("nombres premiers jusqu'à %d: ", n);
    for(int i = 0 ; i<n ; i++)
    {
        if(crible[i]==1)
        {
            printf("%d, ",i);
        }
    }
    printf("\n");
}

void rayer_multiples(char* crible, int n, int k)
{
    // TODO: rayer (i.e. passer à zéro) tous les multiples de k qui sont plus petits que n
    crible[0] = 0;
    crible[1] = 0;
    sleep(5);
    int i = 2;
    while(k*i<n)
    {
        crible[k*i]=0;
        i++;
    }
}


int main(int argc, char **argv)
{
    int n=1000;
    if(argc>1)
    {
        n = atoi(argv[1]);
        assert( n > 0 );
    }

    char * crible = mmap(NULL, n, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_ANONYMOUS, 0, 0);
    assert(crible != MAP_FAILED);

    for(int i=0; i<n; i++)
    {
        crible[i] = 1;//par défaut: pas encore barré
    }
    
    int PIDenfant = 0;
    int passer = 0;

    for(int k=2; k<n; k++)
    {
        if(PIDenfant != 0 || !passer)
        {
            PIDenfant = fork();
            passer = 1;
            if(PIDenfant == 0)
                rayer_multiples(crible, n, k);
        }
    }
    for(int k=2 ; k<n ; k++){
        wait(NULL);
    }

    if(PIDenfant != 0)
        afficher(crible, n);
    
    return 0;
}
